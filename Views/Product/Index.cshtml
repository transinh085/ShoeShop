@model IEnumerable<ShoeShop.Models.Product>
@{
	ViewData["Title"] = "Products";
}
@section Styles {
	<link href="~/css/listing.css" rel="stylesheet">
}

@{
	var categories = ViewBag.Categories;
	var brands = ViewBag.Brands;
	var products = ViewBag.Products as List<Product>;
	var colors = ViewBag.Colors;
	var sizes = ViewBag.Sizes;
	var priceRanges = ViewBag.PriceRanges;
}

<main>
	<div class="top_banner">
		<div class="opacity-mask d-flex align-items-center" data-opacity-mask="rgba(0, 0, 0, 0.3)">
			<div class="container">
				<div class="breadcrumbs">
					<ul>
						<li><a href="#">Home</a></li>
						<li><a href="#">Category</a></li>
						<li>Page active</li>
					</ul>
				</div>
				<h1>Shoes - Grid listing</h1>
			</div>
		</div>
		<img src="~/img/bg_cat_shoes.jpg" class="img-fluid" alt="">
	</div>
	<!-- /top_banner -->
	<div id="stick_here"></div>
	<div class="toolbox elemento_stick">
		<div class="container">
			<ul class="clearfix">
				<li>
					<div class="sort_select">
						<select name="sort" id="sort">
							<option value="date" selected="selected">Sort by newness</option>
							<option value="price">Sort by price: low to high</option>
							<option value="price-desc">Sort by price: high to</option>
						</select>
					</div>
				</li>
				<li>
					<a href="#0"><i class="ti-view-grid"></i></a>
					<a href="listing-row-1-sidebar-left.html"><i class="ti-view-list"></i></a>
				</li>
				<li>
					<a href="#0" class="open_filters">
						<i class="ti-filter"></i><span>Filters</span>
					</a>
				</li>
			</ul>
		</div>
	</div>
	<!-- /toolbox -->

	<div class="container margin_30">

		<div class="row">
			<aside class="col-lg-3" id="sidebar_fixed">
				<div class="filter_col">
					<form method="get">
					<div class="inner_bt"><a href="#" class="open_filters"><i class="ti-close"></i></a></div>
					<div class="filter_type version_2">
						<h4><a href="#categories" data-bs-toggle="collapse" class="opened">Categories</a></h4>
						<div class="collapse show" id="categories">
							<ul>
								@if(categories != null)
								{
									foreach(var category in categories)
									{
										<li>
											<label class="container_check">
													@category.Category.Name <small>@category.ProductCount</small>
													<input type="checkbox" name="categories" value="@category.Category.Id">
												<span class="checkmark"></span>
											</label>
										</li>
									}
								}
							</ul>
						</div>
						<!-- /filter_type -->
					</div>
					<!-- /filter_type -->
					<div class="filter_type version_2">
						<h4><a href="#colors" data-bs-toggle="collapse" class="opened">Colors</a></h4>
						<div class="collapse show" id="colors">
							<ul>
								@if (colors != null)
								{
									foreach (var color in colors)
									{
										<li>
											<label class="container_check">
													@color.Color.Name <small>@color.ProductCount</small>
													<input type="checkbox" name="colors" value="@color.Color.Id">
												<span class="checkmark"></span>
											</label>
										</li>
									}
								}
							</ul>

						</div>
					</div>
					<!-- /filter_type -->
					<div class="filter_type version_2">
							<h4><a href="#lbrands" data-bs-toggle="collapse" class="closed">Brands</a></h4>
							<div class="collapse" id="lbrands">
							<ul>
								@if (brands != null)
								{
									foreach (var brand in brands)
									{
										<li>
											<label class="container_check">
													@brand.Brand.Name <small>@brand.ProductCount</small>
													<input type="checkbox" name="brands" value="@brand.Brand.Id">
												<span class="checkmark"></span>
											</label>
										</li>
									}
								}
							</ul>
						</div>
					</div>
					<!-- /filter_type -->
					<div class="filter_type version_2">
							<h4><a href="#sizes" data-bs-toggle="collapse" class="closed">Sizes</a></h4>
							<div class="collapse" id="sizes">
							<ul>
								@if (sizes != null)
								{
									foreach (var size in sizes)
									{
										<li>
											<label class="container_check">
												@size.Size.Name <small>@size.ProductCount</small>
												<input type="checkbox" name="sizes" value="@size.Size.Id">
												<span class="checkmark"></span>
											</label>
										</li>
									}
								}
							</ul>
						</div>
					</div>
					<!-- /filter_type -->
					<div class="filter_type version_2">
						<h4><a href="#filter_4" data-bs-toggle="collapse" class="closed">Price</a></h4>
						<div class="collapse" id="filter_4">
							<ul>
								@if (priceRanges != null)
								{
									foreach (var priceRange in priceRanges)
									{
										<li>
											<label class="container_check">
												@priceRange.Name<small>@priceRange.ProductCount</small>
												<input type="checkbox" value="@priceRange.Value" name="prices">
												<span class="checkmark"></span>
											</label>
										</li>
									}
								}
							</ul>
						</div>
					</div>
					<!-- /filter_type -->
					<div class="buttons">
						<button type="submit" class="btn_1">Filter</button> <a href="#0" class="btn_1 gray">Reset</a>
					</div>
					</form>
				</div>
			</aside>
			<!-- /col -->
			<div class="col-lg-9">
				<div class="row small-gutters">
					@foreach (var item in ViewBag.Products)
					{
						<div class="col-6 col-md-4">
							@await Component.InvokeAsync("ShoeCards", item)
						</div>
					}
				</div>
				<!-- /row -->
				<div class="pagination__wrapper">
					<ul class="pagination">
						<li><a href="#0" class="prev" title="previous page">&#10094;</a></li>
						<li>
							<a href="#0" class="active">1</a>
						</li>
						<li>
							<a href="#0">2</a>
						</li>
						<li>
							<a href="#0">3</a>
						</li>
						<li>
							<a href="#0">4</a>
						</li>
						<li><a href="#0" class="next" title="next page">&#10095;</a></li>
					</ul>
				</div>
			</div>
			<!-- /col -->
		</div>
		<!-- /row -->

	</div>
	<!-- /container -->
</main>

@section Scripts {
	<script src="~/js/sticky_sidebar.min.js"></script>
	<script src="~/js/specific_listing.js"></script>
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const categoriesCheckboxes = document.querySelectorAll("input[name=categories]");
			const colorsCheckboxes = document.querySelectorAll("input[name=colors]");
			const brandsCheckboxes = document.querySelectorAll("input[name=brands]");
			const sizesCheckboxes = document.querySelectorAll("input[name=sizes]");
			const pricesCheckboxes = document.querySelectorAll("input[name=prices]");

			function updateURL() {
				const checkedCategories = getCheckedValues(categoriesCheckboxes);
				const checkedColors = getCheckedValues(colorsCheckboxes);
				const checkedBrands = getCheckedValues(brandsCheckboxes);
				const checkedSizes = getCheckedValues(sizesCheckboxes);
				const checkedPrices = getCheckedValues(pricesCheckboxes);

				const queryParams = [];

				if (checkedCategories.length > 0) {
					queryParams.push(`categories=${checkedCategories.join(",")}`);
				}
				if (checkedColors.length > 0) {
					queryParams.push(`colors=${checkedColors.join(",")}`);
				}
				if (checkedBrands.length > 0) {
					queryParams.push(`brands=${checkedBrands.join(",")}`);
				}
				if (checkedSizes.length > 0) {
					queryParams.push(`sizes=${checkedSizes.join(",")}`);
				}
				if (checkedPrices.length > 0) {
					queryParams.push(`prices=${checkedPrices.join(",")}`);
				}

				const url = window.location.href.split('?')[0];
				const finalURL = queryParams.length > 0 ? `${url}?${queryParams.join("&")}` : url;

				history.replaceState(null, null, finalURL);

				// Now, update the checkboxes based on the URL parameters
				updateCheckboxesFromURLParameters();
			}

			function getCheckedValues(checkboxes) {
				return Array.from(checkboxes)
					.filter(checkbox => checkbox.checked)
					.map(checkbox => checkbox.value);
			}

			function updateCheckboxesFromURLParameters() {
				const urlParams = new URLSearchParams(window.location.search);
				categoriesCheckboxes.forEach(checkbox => {
					checkbox.checked = urlParams.get("categories")?.split(",").includes(checkbox.value);
				});
				colorsCheckboxes.forEach(checkbox => {
					checkbox.checked = urlParams.get("colors")?.split(",").includes(checkbox.value);
				});
				brandsCheckboxes.forEach(checkbox => {
					checkbox.checked = urlParams.get("brands")?.split(",").includes(checkbox.value);
				});
				sizesCheckboxes.forEach(checkbox => {
					checkbox.checked = urlParams.get("sizes")?.split(",").includes(checkbox.value);
				});
				pricesCheckboxes.forEach(checkbox => {
					checkbox.checked = urlParams.get("prices")?.split(",").includes(checkbox.value);
				});
			}

			categoriesCheckboxes.forEach(checkbox => {
				checkbox.addEventListener("change", updateURL);
			});

			colorsCheckboxes.forEach(checkbox => {
				checkbox.addEventListener("change", updateURL);
			});

			brandsCheckboxes.forEach(checkbox => {
				checkbox.addEventListener("change", updateURL);
			});

			sizesCheckboxes.forEach(checkbox => {
				checkbox.addEventListener("change", updateURL);
			});

			pricesCheckboxes.forEach(checkbox => {
				checkbox.addEventListener("change", updateURL);
			});


			// Call this function to initialize checkboxes based on URL parameters
			updateCheckboxesFromURLParameters();
		});
	</script>
}



